name: Sync Docker Hub Overview

on:
  push:
    branches: [ main ]
    paths:
      - README.md
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Docker Hub description
        id: hubdesc
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # e.g., rjsears (or rjsears+robot)
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # Hub access token
          repository: rjsears/tftpgui
          short-description: "Full-featured TFTP server (GUI & headless) with Docker support"
          readme-filepath: README.md

      # Optional: quick verify to print length & preview to logs
      - name: Verify description updated (length & preview)
        env:
          DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -e
          JWT=$(curl -s -H "Content-Type: application/json" \
            -d "{\"username\":\"$DH_USER\",\"password\":\"$DH_TOKEN\"}" \
            https://hub.docker.com/v2/users/login/ | python3 -c 'import sys,json; print(json.load(sys.stdin).get("token",""))')
          [ -z "$JWT" ] && { echo "ERROR: No JWT"; exit 1; }
          curl -s -H "Authorization: JWT $JWT" https://hub.docker.com/v2/repositories/rjsears/tftpgui/ \
            | python3 - <<'PY'
import sys, json
data=json.load(sys.stdin)
desc=data.get("full_description","")
print("Desc length:", len(desc))
print("Preview:", (desc[:160] + ("..." if len(desc)>160 else "")))
PY
